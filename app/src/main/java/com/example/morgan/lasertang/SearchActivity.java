package com.example.morgan.lasertang;import android.content.BroadcastReceiver;import android.content.ComponentName;import android.content.Context;import android.content.Intent;import android.content.IntentFilter;import android.content.ServiceConnection;import android.os.IBinder;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;import android.view.View;import android.widget.AdapterView;import android.widget.ArrayAdapter;import android.widget.Button;import android.widget.ListView;import android.widget.ProgressBar;import android.widget.TextView;import android.widget.Toast;public class SearchActivity extends AppCompatActivity implements View.OnClickListener {    String LOG = "SEARCH_ACTIVITY_LOG";    int mainActivityRequestCode = 1;    BTDevicesReceiver newBTdevice;    boolean mBounded;    BTService bt_service;    ArrayAdapter<String> namesAdapter;    ProgressBar progressBar;    Button searchBtn;    ListView listView;    TextView username;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_search);        Intent mIntent = new Intent(this, BTService.class);        bindService(mIntent, mConnection, BIND_AUTO_CREATE);        progressBar = (ProgressBar) findViewById(R.id.ProgSearch);        searchBtn = (Button) findViewById(R.id.btnSearch);        username = (TextView) findViewById(R.id.textUsername);        username.setText("");        newBTdevice = new BTDevicesReceiver();        IntentFilter intentFilter = new IntentFilter();        intentFilter.addAction(BTService.searchStarted);        intentFilter.addAction(BTService.newDevice);        intentFilter.addAction(BTService.searchStopped);        intentFilter.addAction(BTService.tankConnected);        intentFilter.addAction(BTService.tankDisconnected);        registerReceiver(newBTdevice, intentFilter);        namesAdapter = new ArrayAdapter<>(this, android.R.layout.simple_list_item_1);        listView = (ListView) findViewById(R.id.deviceList);        if (listView != null) {            listView.setAdapter(namesAdapter);        } else {            Toast.makeText(this, "listView != null", Toast.LENGTH_SHORT).show();        }        searchBtn.setOnClickListener(this);        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {            public void onItemClick(AdapterView<?> parent, View view,                                    int position, long id) {                Log.d(LOG, namesAdapter.getItem(position));                if(!bt_service.connect(namesAdapter.getItem(position))){                    // Toast.makeText(this, "Cannot connect", Toast.LENGTH_SHORT).show();                }            }        });    }    @Override    protected void onStart() {        super.onStart();        Log.d(LOG, "onStart");    }    @Override    protected void onStop() {        super.onStop();        Log.d(LOG, "onStop");    }    @Override    protected void onPause() {        super.onPause();        Log.d(LOG, "onPause");    }    @Override    protected void onResume() {        super.onResume();        Log.d(LOG, "onResume");    }    @Override    protected void onDestroy() {        super.onDestroy();        unbindService(mConnection);        unregisterReceiver(newBTdevice);    }    private class BTDevicesReceiver extends BroadcastReceiver {        @Override        public void onReceive(Context arg0, Intent arg1) {            String action = arg1.getAction();            if(action.equals(BTService.newDevice)) {                String deviceName = arg1.getStringExtra("NAME");                namesAdapter.add(deviceName);//                Log.d(LOG, deviceName);            }            if(action.equals(BTService.searchStarted)) {                progressBar.setVisibility(ProgressBar.VISIBLE);                Log.d(LOG, "searchStarted");            }            if(action.equals(BTService.tankConnected)) {                Log.d(LOG, "tankConnected");                String deviceName = arg1.getStringExtra("NAME");                Intent intent = new Intent(SearchActivity.this, SettingsActivity.class);                intent.putExtra("NAME", deviceName);                startActivityForResult(intent, mainActivityRequestCode);            }            if(action.equals(BTService.tankDisconnected)) {                Log.d(LOG, "Sorry lost connection");            }            if(action.equals(BTService.searchStopped)) {                progressBar.setVisibility(ProgressBar.INVISIBLE);                Log.d(LOG, "searchStopped");            }        }    }    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        Log.d(LOG, "requestCode = " + requestCode + ", resultCode = " + resultCode);        if (resultCode == RESULT_OK) {            Toast.makeText(this, "tank disconnected", Toast.LENGTH_SHORT).show();            finishActivity(mainActivityRequestCode);        } else {            Toast.makeText(this, "Something happend", Toast.LENGTH_SHORT).show();        }    }    @Override    public void onClick(View v) {//        startService(new Intent(this, BTService.class));        bt_service.startBluetooth();    }    ServiceConnection mConnection = new ServiceConnection() {        public void onServiceDisconnected(ComponentName name) {            mBounded = false;            bt_service = null;        }        public void onServiceConnected(ComponentName name, IBinder service) {            mBounded = true;            BTService.LocalBinder mLocalBinder = (BTService.LocalBinder)service;            bt_service = mLocalBinder.getServerInstance();        }    };}