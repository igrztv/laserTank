package com.example.morgan.lasertang;import android.content.BroadcastReceiver;import android.content.ComponentName;import android.content.Context;import android.content.Intent;import android.content.IntentFilter;import android.content.ServiceConnection;import android.net.Uri;import android.os.IBinder;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;import android.view.MotionEvent;import android.view.View;import android.widget.Button;import android.widget.ImageView;import android.widget.TextView;import android.widget.Toast;import android.widget.ZoomButton;public class MainActivity extends AppCompatActivity implements View.OnClickListener, View.OnTouchListener {    // Tank Commands    private static final byte CMD_SHOOT = 0x01;    private static final byte CMD_MOVE = 0x02;    private static final byte CMD_TURRET = 0x03;    // Activity elements    ImageView moveBtn;    Button shootBtn;    ZoomButton turretLeft;    ZoomButton turretRight;    ImageView joystickSpace;    String LOG = "MAIN_ACTIVITY_LOG";    BTDevicesReceiver newBTdevice;    BTService bt_service;    boolean mBounded;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        Intent mIntent = new Intent(this, BTService.class);        bindService(mIntent, mConnection, BIND_AUTO_CREATE);        moveBtn = (ImageView) findViewById(R.id.move_btn);        shootBtn = (Button) findViewById(R.id.shoot_btn);        turretLeft = (ZoomButton) findViewById(R.id.turretLeft);        turretRight = (ZoomButton) findViewById(R.id.turretRight);        joystickSpace = (ImageView) findViewById(R.id.moveBtnSpace);        moveBtn.setOnClickListener(this);        shootBtn.setOnClickListener(this);        turretRight.setOnTouchListener(this);        turretLeft.setOnTouchListener(this);        moveBtn.setOnTouchListener(this);        newBTdevice = new BTDevicesReceiver();        IntentFilter intentFilter = new IntentFilter();        intentFilter.addAction(BTService.tankDisconnected);        registerReceiver(newBTdevice, intentFilter);        // запуск bluetooth        // startService(new Intent(this, BTService.class));    }    @Override    protected void onStart() {        super.onStart();        Log.d(LOG, "onStart");    }    @Override    protected void onStop() {        super.onStop();        Log.d(LOG, "onStop");    }    @Override    protected void onPause() {        super.onPause();        Log.d(LOG, "onPause");    }    @Override    protected void onResume() {        super.onResume();        Log.d(LOG, "onResume");    }    private class BTDevicesReceiver extends BroadcastReceiver {        @Override        public void onReceive(Context arg0, Intent arg1) {            Log.d(LOG, "Sorry lost connection");            MainActivity.this.finish();        }    }    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        Log.d("myLogs", "requestCode = " + requestCode + ", resultCode = " + resultCode);        if (resultCode == RESULT_OK) {        } else {            Toast.makeText(this, "Something happend", Toast.LENGTH_SHORT).show();        }    }    @Override    protected void onDestroy() {        super.onDestroy();        unbindService(mConnection);        unregisterReceiver(newBTdevice);    }    @Override    public void onClick(View v) {        if (v == shootBtn) {            byte[] bufToSend = {CMD_SHOOT, '\n'};            bt_service.sendCMD(bufToSend);        }    }    private boolean touchMoveButton(View v, MotionEvent event) {        Log.d(LOG, "touchMoveButton");        int action = event.getAction();        if (action == MotionEvent.ACTION_UP) {            v.setX(joystickSpace.getX() + joystickSpace.getWidth() / 2 - v.getWidth() / 2);            v.setY(joystickSpace.getY() + joystickSpace.getHeight() / 2 - v.getHeight() / 2);            return false;        }        int pointerIndex = 0;        MotionEvent.PointerCoords coords = new MotionEvent.PointerCoords();        event.getPointerCoords(pointerIndex, coords);        TextView tX = (TextView) findViewById(R.id.textView);        TextView tY = (TextView) findViewById(R.id.textView2);//        float cR = v.getWidth() / 2;//        float sR = joystickSpace.getWidth() / 2;        // центр джойстика        float cX = v.getX() - v.getWidth() / 2 + coords.x;        float cY = v.getY() - v.getHeight() / 2 + coords.y;//        MotionEvent.PointerCoords cP = new MotionEvent.PointerCoords();//        MotionEvent.PointerCoords cS = new MotionEvent.PointerCoords();//        cP.x = cX + v.getWidth() / 2;//        cP.y = cY + v.getHeight() / 2;////        cS.x = joystickSpace.getX() + joystickSpace.getWidth() / 2;//        cS.y = joystickSpace.getY() + joystickSpace.getHeight() / 2;//        if(    (cP.x - cS.x)*(cP.x - cS.x) + (cP.y - cS.y)*(cP.y - cS.y) < (sR-cR)*(sR-cR)      ) {//            v.setX(cX);//            v.setY(cY);//        }        // рисуем джойстик только внутри зоны для джойстика        if (cX >= joystickSpace.getX() && cX <= joystickSpace.getWidth() + joystickSpace.getX() - v.getWidth()) {            v.setX(cX);        }        if (cY >= joystickSpace.getY() && cY <= joystickSpace.getHeight() + joystickSpace.getY() - v.getHeight()) {            v.setY(cY);        }        int xMove = Math.round((v.getX() - joystickSpace.getX()) / (joystickSpace.getWidth() - v.getWidth()) * 255);        int yMove = Math.round((v.getY() - joystickSpace.getY()) / (joystickSpace.getHeight() - v.getHeight()) * 255);        if (tX != null) {            tX.setText(String.format("%d", xMove));        }        if (tY != null) {            tY.setText(String.format("%d", yMove));        }        Log.d(LOG, "cX " + (xMove) + " cY " + (yMove));        // TODO: scale cX and cY to byte size        byte[] bufToSend = {CMD_MOVE, ':', (byte) xMove, ',', (byte) yMove, '\n'};        bt_service.sendCMD(bufToSend);        return true;    }    private boolean touchTurret(View v, MotionEvent event, String direction) {        Log.d(LOG, "touchTurret");        int action = event.getAction();        if (action == MotionEvent.ACTION_UP) {            return true;        }        byte dir = 0;        byte delta = 1;        if (direction.equals("left")) {            dir = '-';        }        if (direction.equals("right")) {            dir = '+';        }        byte[] bufToSend = {CMD_TURRET, ':', dir, ',', delta, '\n'};        bt_service.sendCMD(bufToSend);        return true;    }    @Override    public boolean onTouch(View v, MotionEvent event) {        if (v == moveBtn) {            return touchMoveButton(v, event);        }        if (v == turretLeft) {            return touchTurret(v, event, "left");        }        if (v == turretRight) {            return touchTurret(v, event, "right");        }        return true;    }    ServiceConnection mConnection = new ServiceConnection() {        public void onServiceDisconnected(ComponentName name) {            mBounded = false;            bt_service = null;        }        public void onServiceConnected(ComponentName name, IBinder service) {            mBounded = true;            BTService.LocalBinder mLocalBinder = (BTService.LocalBinder) service;            bt_service = mLocalBinder.getServerInstance();        }    };}